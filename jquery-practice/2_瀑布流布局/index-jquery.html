<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        #main {
            position: relative;
        }

        .box {
            padding: 15px 0 0 15px;
            float: left;
        }

        .pic {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 5px #ccc;
        }

        .pic img{
            width:165px;
            height:auto;
        }
    </style>

    <script src="../../jquery-validation/jquery-validation-1.15.0/lib/jquery-1.11.1.js"></script>
    <script type="text/javascript">
        $(document).ready(function(){
            waterfall();
            var currentIndex = 22;
            $(window).on("scroll",function(){
                if(needToLoadMore()){
                    console.log("load more ...");
                    // 模拟后台获取
                    var data = [];
                    for(var i = 0; i < 20; i++){
                        currentIndex++;
                        if(currentIndex > 97){
                            currentIndex = 0;
                        }
                        data.push(
                                {
                                    src:"images/"+currentIndex+".jpg"
                                }
                        )
                    }

                    $.each(data,function(index,value){
                        var box = $('<div>').addClass("box").appendTo($("#main"));
                        var pic = $("<div>").addClass("pic").appendTo(box);
                        $("<img>").attr("src",value.src).appendTo(pic);
                    });

                    waterfall();

                }
            })
        });

        function waterfall(){
            var $boxes = $("#main>div");
            var boxWidth = $boxes.eq(0).outerWidth();
//            console.log(boxWidth);
            var cols = Math.floor($(window).width() / boxWidth);
            $("#main").width(boxWidth * cols).css("margin","0 auto");

            var heightArray = [];
            $boxes.each(function(index,value){
                var h = $boxes.eq(index).outerHeight();
                if(index < cols){
                    heightArray[index] = h;
                }else{
                    var minH = Math.min.apply(null,heightArray);
                    var minIndex = $.inArray(minH,heightArray);
                    $(value).css({
                        "position":"absolute",
                        "top":minH+"px",
                        "left":minIndex*boxWidth+"px"
                    });
                    heightArray[minIndex]+=$(value).outerHeight();
                }
            })
        }

        function needToLoadMore(){
            var $lastBox = $("#main>div").last();
            var lastBoxOffsetTop = $lastBox.offset().top + Math.floor($lastBox.outerHeight() / 2);

            var scrollTop = $(window).scrollTop();
            var windowHeight = $(window).height();
            return scrollTop+windowHeight > lastBoxOffsetTop;
        }
    </script>
</head>
<body>
<div id="main">

    <div class="box">
        <div class="pic">
            <img src="images/0.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/1.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/2.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/3.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/4.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/5.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/6.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/7.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/8.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/9.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/10.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/11.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/12.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/13.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/14.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/15.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/16.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/17.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/18.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/19.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/20.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/21.jpg"/>
        </div>
    </div>

    <div class="box">
        <div class="pic">
            <img src="images/22.jpg"/>
        </div>
    </div>
</div>
</body>
</html>